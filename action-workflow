name: Build Task Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'docker/extract/**'
      - 'docker/upload_s3/**'
      - 'docker/transform/**'
      - 'docker/train/**'
      - 'docker/evaluate/**'
      - 'docker/save_parquet/**'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: [extract, upload_s3, transform, train, evaluate, save_parquet]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Detect if changes exist in the task folder
      - name: Check for changes in ${{ matrix.task }}
        id: changes
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^docker/${{ matrix.task }}/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Build only if changes were detected
      - name: Build Docker image
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "Building Docker image for task: ${{ matrix.task }}"
          docker build -t ${{ matrix.task }}:latest ./docker/${{ matrix.task }}

      # Optional: Push to DockerHub or ECR
      - name: Login to DockerHub
        if: steps.changes.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        if: steps.changes.outputs.changed == 'true'
        run: |
          docker tag ${{ matrix.task }}:latest ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.task }}:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.task }}:latest
